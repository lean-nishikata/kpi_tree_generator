<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KPI Tree Example</title>
  <style>
    /* General styles */
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f5f5f5;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

h1 {
  text-align: center;
  color: #333;
}

/* KPI Tree styles - Common */
.kpi-tree-container {
  overflow: auto;
  padding: 20px;
  margin: 0 auto;
}

.kpi-tree {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

/* Vertical direction styles */
.direction-vertical .kpi-tree {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.direction-vertical .kpi-tree ul {
  list-style-type: none;
  padding: 20px 0 0 0;
  display: flex;
  flex-wrap: nowrap;
  justify-content: center;
  position: relative;
}

.direction-vertical .kpi-tree li {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0 15px;
}

.direction-vertical .kpi-tree ul::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  border-top: 2px solid #ccc;
  width: 100%;
}

.direction-vertical .children > li::before {
  content: '';
  position: absolute;
  top: -20px;
  left: 50%;
  border-left: 2px solid #ccc;
  height: 20px;
  transform: translateX(-50%);
}

.direction-vertical .operator {
  margin: 10px 0;
}

.direction-vertical .toggle-btn {
  margin-top: 10px;
  margin-bottom: 0;
}

/* Horizontal direction styles */
.direction-horizontal .kpi-tree {
  display: flex;
  align-items: center;
}

.direction-horizontal .kpi-tree ul {
  list-style-type: none;
  padding: 0 0 0 20px;
  display: flex;
  flex-direction: column;
  position: relative;
}

.direction-horizontal .kpi-tree li {
  display: flex;
  flex-direction: row;
  align-items: center;
  margin: 3px 0; /* 上下の余白をさらに詰める（15pxから3pxに） */
}

.direction-horizontal .kpi-tree ul::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  border-left: 2px solid #ccc;
  height: 100%;
}

.direction-horizontal .children > li::before {
  content: '';
  position: absolute;
  left: -20px;
  top: 50%;
  border-top: 2px solid #ccc;
  width: 20px;
  transform: translateY(-50%);
}

.direction-horizontal .operator {
  margin: 0 10px;
}

.direction-horizontal .toggle-btn {
  margin: 0 10px;
}

/* Node styles */
.node {
  min-width: 120px;
  min-height: 70px;
  padding: 10px;
  background-color: #fff;
  border: 2px solid #666;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: center;
  position: relative;
}

.node a {
  color: #0066cc;
  text-decoration: none;
}

.node a:hover {
  text-decoration: underline;
}

.node .value {
  font-weight: bold;
  margin-top: 5px;
  color: #333;
}

/* Operator styles */
.operator {
  font-size: 32px; /* フォントサイズを大きく */
  font-weight: bold;
  color: #666; /* 元の色に戻す */
  width: 45px; /* 幅を大きく */
  height: 45px; /* 高さを大きく */
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f0f0f0; /* 元の背景色に戻す */
  border-radius: 50%;
  z-index: 10; /* 前面に表示 */
  box-shadow: 0 2px 4px rgba(0,0,0,0.3); /* 影を追加 */
  border: 2px solid #ddd; /* 境界線色を元に近い色に調整 */
}

/* Toggle button styles */
.toggle-btn {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background-color: #ddd;
  border: 1px solid #999;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  position: relative;
  font-size: 0;
  z-index: 2;
}

.toggle-btn::before {
  content: '−';
  font-size: 16px;
  line-height: 1;
}

.toggle-btn.collapsed::before {
  content: '+';
}

/* Collapsed state */
.children.collapsed {
  display: none !important;
}

/* Theme colors */
.theme-default .node {
  border-color: #00796b;
  background-color: #e0f2f1;
}

.theme-blue .node {
  border-color: #1976d2;
  background-color: #e3f2fd;
}

.theme-red .node {
  border-color: #d32f2f;
  background-color: #ffebee;
}
  </style>
</head>
<body data-theme="default" data-direction="horizontal">
  <div class="container">
    <h1>KPI Tree Example</h1>
    <div class="kpi-tree-container theme-default direction-horizontal">
      <ul class="kpi-tree">
        
    <li>
      <div class="node" id="node-hjfbkwuph">
        <a href="https://example.com/revenue" target="_blank">Revenue (JPY)</a><div class="value">300,000,000</div>
      </div>
      <button class="toggle-btn" data-target="node-hjfbkwuph-children"></button>
      <ul id="node-hjfbkwuph-children" class="children">
    <li>
      <div class="node" id="node-z6esn79i4">
        Product A<div class="value">150,000,000</div>
      </div>
      <button class="toggle-btn" data-target="node-z6esn79i4-children"></button>
      <ul id="node-z6esn79i4-children" class="children">
    <li>
      <div class="node" id="node-hl6hqfjsu">
        Active Users<div class="value">100,000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-34rnclecu">
        ARPU<div class="value">1,500</div>
      </div>
      <button class="toggle-btn" data-target="node-34rnclecu-children"></button>
      <ul id="node-34rnclecu-children" class="children">
    <li>
      <div class="node" id="node-e8oaeh6ea">
        ARPPU<div class="value">10,000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-pyua8r1tl">
        課金率<div class="value">15%</div>
      </div>
    </li>
      </ul>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-f0asij4nn">
        Product B<div class="value">150,000,000</div>
      </div>
      <button class="toggle-btn" data-target="node-f0asij4nn-children"></button>
      <ul id="node-f0asij4nn-children" class="children">
    <li>
      <div class="node" id="node-ww1he5y28">
        Active Users<div class="value">100,000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-f4mwhpp9q">
        ARPU<div class="value">1,500</div>
      </div>
      <button class="toggle-btn" data-target="node-f4mwhpp9q-children"></button>
      <ul id="node-f4mwhpp9q-children" class="children">
    <li>
      <div class="node" id="node-zivxvux1u">
        ARPPU<div class="value">10,000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-tpf11ubyz">
        課金率<div class="value">15%</div>
      </div>
    </li>
      </ul>
    </li>
      </ul>
    </li>
      </ul>
    </li>
      </ul>
    </div>
  </div>
  
  <script>
    // KPI Tree JavaScript
// Using old-school function approach to ensure maximum browser compatibility
function kpiTreeInit() {
  console.log('KPI Tree initializing...');
  console.log('URL:', window.location.href);
  
  // まずURLパラメータから方向を取得
  var urlDirection = getDirectionFromUrl();
  
  // Apply theme and direction from config or URL
  var theme = document.body.getAttribute('data-theme') || 'default';
  var direction = urlDirection || document.body.getAttribute('data-direction') || 'vertical';
  
  console.log('KPI Tree initializing with direction:', direction);
  
  // 方向を設定
  setDirection(direction);
  
  // Add direction toggle control
  addDirectionToggle(direction);
  
  // Add share button for permanent link
  addShareButton();
  
  // Initialize toggle buttons
  setupToggleButtons();
  
  // 初期化後にシェアURLを更新
  setTimeout(function() {
    updateShareUrl();
  }, 500);
}

// URLパラメータから方向を取得
function getDirectionFromUrl() {
  var urlParams = new URLSearchParams(window.location.search);
  var direction = urlParams.get('direction');
  
  if (direction === 'vertical' || direction === 'horizontal') {
    console.log('Direction from URL:', direction);
    return direction;
  }
  
  return null;
}

// 方向を設定する関数
function setDirection(direction) {
  var treeContainer = document.querySelector('.kpi-tree-container');
  var body = document.body;
  
  // Remove old direction class
  treeContainer.classList.remove('direction-vertical');
  treeContainer.classList.remove('direction-horizontal');
  
  // Add new direction class
  treeContainer.classList.add('direction-' + direction);
  
  // Update data attribute
  body.setAttribute('data-direction', direction);
}

// Handle toggle buttons for collapsing/expanding nodes
function setupToggleButtons() {
  console.log('Setting up toggle buttons');
  
  // Get all toggle buttons
  var toggleButtons = document.querySelectorAll('.toggle-btn');
  console.log('Found toggle buttons:', toggleButtons.length);
  
  // First check URL parameters for state
  var urlStates = getStateFromUrl();
  console.log('URL states:', urlStates);
  
  // If no URL parameters, load from localStorage
  var savedStates = Object.keys(urlStates).length > 0 ? urlStates : loadTreeState();
  console.log('Using states:', savedStates);
  
  // ツリーの状態を適用する前に、まずすべてのノードを展開状態にする
  resetAllNodes();
  
  // Initialize toggle buttons
  for (var i = 0; i < toggleButtons.length; i++) {
    var button = toggleButtons[i];
    var targetId = button.getAttribute('data-target');
    var target = document.getElementById(targetId);
    
    if (!target) {
      console.error('Target element not found:', targetId);
      continue;
    }
    
    console.log('Checking state for:', targetId, 'State:', savedStates[targetId]);
    
    // Apply saved state if exists
    if (savedStates[targetId] === 'collapsed') {
      console.log('Collapsing:', targetId);
      target.classList.add('collapsed');
      button.classList.add('collapsed');
    }
    // 展開状態の場合は、既にresetAllNodes()で展開済み
    
    // Use closure to maintain button and target references
    (function(btn, tgt) {
      btn.onclick = function() {
        console.log('Toggle button clicked for:', tgt.id);
        tgt.classList.toggle('collapsed');
        btn.classList.toggle('collapsed');
        saveTreeState();
        updateShareUrl();
      };
    })(button, target);
  }
}

// Add direction toggle dropdown
function addDirectionToggle(initialDirection) {
  // Create toggle control
  var controlDiv = document.createElement('div');
  controlDiv.className = 'direction-control';
  controlDiv.style.position = 'fixed';
  controlDiv.style.top = '10px';
  controlDiv.style.right = '10px';
  controlDiv.style.zIndex = '1000';
  controlDiv.style.background = '#fff';
  controlDiv.style.padding = '5px 10px';
  controlDiv.style.borderRadius = '4px';
  controlDiv.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
  
  // Create select element
  var select = document.createElement('select');
  select.id = 'directionToggle';
  
  // Add options
  var vertOption = document.createElement('option');
  vertOption.value = 'vertical';
  vertOption.textContent = '縦向きレイアウト';
  vertOption.selected = initialDirection === 'vertical';
  
  var horizOption = document.createElement('option');
  horizOption.value = 'horizontal';
  horizOption.textContent = '横向きレイアウト';
  horizOption.selected = initialDirection === 'horizontal';
  
  select.appendChild(vertOption);
  select.appendChild(horizOption);
  
  // Add event listener using old-school approach
  select.onchange = function() {
    // 新しい方向を設定
    setDirection(this.value);
    
    // Save preference to localStorage
    localStorage.setItem('kpiTreeDirection', this.value);
    
    // Update share URL
    updateShareUrl();
  };
  
  // Add label
  var label = document.createElement('label');
  label.htmlFor = 'directionToggle';
  label.textContent = 'レイアウト: ';
  label.style.marginRight = '5px';
  label.style.fontWeight = 'bold';
  
  // Append to control div
  controlDiv.appendChild(label);
  controlDiv.appendChild(select);
  
  // Append to body
  document.body.appendChild(controlDiv);
  
  // 初期値をセレクトボックスに設定
  select.value = initialDirection;
}

// Save tree state to localStorage
function saveTreeState() {
  var state = {};
  var children = document.querySelectorAll('.children');
  
  for (var i = 0; i < children.length; i++) {
    var child = children[i];
    if (child.id) {
      state[child.id] = child.classList.contains('collapsed') ? 'collapsed' : 'expanded';
    }
  }
  
  localStorage.setItem('kpiTreeState', JSON.stringify(state));
  return state;
}

// Load tree state from localStorage
function loadTreeState() {
  var savedState = localStorage.getItem('kpiTreeState');
  return savedState ? JSON.parse(savedState) : {};
}

// Get state from URL parameters
function getStateFromUrl() {
  var urlParams = new URLSearchParams(window.location.search);
  var stateParam = urlParams.get('state');
  
  if (!stateParam) {
    console.log('No state parameter in URL');
    return {};
  }
  
  try {
    // URLデコード後、URL-safe base64 decode
    console.log('Raw state param:', stateParam);
    var decodedState = decodeURIComponent(stateParam);
    console.log('URL decoded state:', decodedState);
    decodedState = atob(decodedState.replace(/-/g, '+').replace(/_/g, '/'));
    console.log('Base64 decoded state:', decodedState);
    var parsedState = JSON.parse(decodedState);
    console.log('Parsed state:', parsedState);
    return parsedState;
  } catch (e) {
    console.error('Error parsing state from URL:', e);
    return {};
  }
}

// Generate URL-safe state parameter
function generateStateParam(state) {
  // URL-safe base64 encode
  var encoded = btoa(JSON.stringify(state)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  // URLエンコード
  return encodeURIComponent(encoded);
}

// Add share button for permanent link
function addShareButton() {
  var shareDiv = document.createElement('div');
  shareDiv.className = 'share-control';
  shareDiv.style.position = 'fixed';
  shareDiv.style.top = '50px';
  shareDiv.style.right = '10px';
  shareDiv.style.zIndex = '1000';
  shareDiv.style.background = '#fff';
  shareDiv.style.padding = '5px 10px';
  shareDiv.style.borderRadius = '4px';
  shareDiv.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
  
  var shareButton = document.createElement('button');
  shareButton.id = 'shareButton';
  shareButton.textContent = '現在の表示状態を共有';
  shareButton.style.padding = '5px 10px';
  shareButton.style.cursor = 'pointer';
  shareButton.style.backgroundColor = '#4CAF50';
  shareButton.style.color = 'white';
  shareButton.style.border = 'none';
  shareButton.style.borderRadius = '4px';
  
  // Add event listener
  shareButton.onclick = function() {
    copyShareUrlToClipboard();
  };
  
  // Add tooltip span
  var tooltip = document.createElement('span');
  tooltip.id = 'shareTooltip';
  tooltip.textContent = '';
  tooltip.style.marginLeft = '10px';
  tooltip.style.fontSize = '12px';
  tooltip.style.opacity = '0';
  tooltip.style.transition = 'opacity 0.3s';
  
  // Append to share div
  shareDiv.appendChild(shareButton);
  shareDiv.appendChild(tooltip);
  
  // Append to body
  document.body.appendChild(shareDiv);
  
  // Initialize share URL
  updateShareUrl();
}

// Update share URL when tree state changes
function updateShareUrl() {
  var state = saveTreeState();
  var stateParam = generateStateParam(state);
  var direction = document.body.getAttribute('data-direction') || 'vertical';
  
  // Create URL with parameters
  var url = new URL(window.location.href);
  // URLのハッシュ部分とクエリパラメータを削除
  url.hash = '';
  url.search = '';
  
  // パラメータを追加
  url.searchParams.set('state', stateParam);
  url.searchParams.set('direction', direction);
  
  // Store URL for copy button
  window._shareUrl = url.toString();
  console.log('Share URL updated:', window._shareUrl);
  
  // ブラウザのURLを動的に更新
  updateBrowserUrl(url.toString());
}

// Copy share URL to clipboard
function copyShareUrlToClipboard() {
  if (!window._shareUrl) {
    updateShareUrl();
  }
  
  // Create temporary input element
  var tempInput = document.createElement('input');
  tempInput.style.position = 'absolute';
  tempInput.style.left = '-9999px';
  tempInput.value = window._shareUrl;
  document.body.appendChild(tempInput);
  
  // Select and copy
  tempInput.select();
  document.execCommand('copy');
  document.body.removeChild(tempInput);
  
  // Show tooltip
  var tooltip = document.getElementById('shareTooltip');
  tooltip.textContent = 'リンクをコピーしました！';
  tooltip.style.opacity = '1';
  
  // Hide tooltip after 2 seconds
  setTimeout(function() {
    tooltip.style.opacity = '0';
  }, 2000);
}

// すべてのノードを展開状態にリセットする関数
function resetAllNodes() {
  var children = document.querySelectorAll('.children');
  var buttons = document.querySelectorAll('.toggle-btn');
  
  // すべての子ノードを展開状態にする
  for (var i = 0; i < children.length; i++) {
    children[i].classList.remove('collapsed');
  }
  
  // すべてのボタンを展開状態にする
  for (var i = 0; i < buttons.length; i++) {
    buttons[i].classList.remove('collapsed');
  }
  
  console.log('All nodes reset to expanded state');
}

// ブラウザのURLを動的に更新する関数
function updateBrowserUrl(url) {
  // History APIを使用してURLを更新
  if (window.history && window.history.replaceState) {
    try {
      window.history.replaceState({}, document.title, url);
    } catch (e) {
      console.error('Error updating browser URL:', e);
    }
  }
}

// Run initialization when page is loaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', kpiTreeInit);
} else {
  kpiTreeInit();
}

  </script>
</body>
</html>