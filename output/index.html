<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>利益KPIツリー</title>
  <style>
    /* General styles */
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f5f5f5;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

h1 {
  text-align: center;
  color: #333;
}

/* KPI Tree styles - Common */
.kpi-tree-container {
  overflow: auto;
  padding: 20px;
  margin: 0 auto;
}

.kpi-tree {
  list-style-type: none;
  padding: 0;
  margin: 0;
}



/* Horizontal direction styles */
.direction-horizontal .kpi-tree {
  display: flex;
  align-items: center;
}

.direction-horizontal .kpi-tree ul {
  list-style-type: none;
  padding: 0 0 0 20px;
  display: flex;
  flex-direction: column;
  position: relative;
}

.direction-horizontal .kpi-tree li {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  margin: 3px 0; /* 上下の余白をさらに詰める（15pxから3pxに） */
}

.direction-horizontal .kpi-tree ul::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  border-left: 2px solid #ccc;
  height: 100%;
}

.direction-horizontal .children > li::before {
  content: '';
  position: absolute;
  left: -20px;
  top: 50%;
  border-top: 2px solid #ccc;
  width: 20px;
  transform: translateY(-50%);
}

.direction-horizontal .operator {
  margin: 0 10px;
}

.direction-horizontal .toggle-btn {
  margin: 0 10px;
}

/* Node styles */
.node {
  min-width: 120px;
  min-height: 70px;
  padding: 10px;
  background-color: #fff;
  border: 2px solid #666;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: center;
  position: relative;
}

.node a {
  color: #0066cc;
  text-decoration: none;
}

.node a:hover {
  text-decoration: underline;
}

.node .value {
  font-weight: bold;
  margin-top: 5px;
  color: #333;
}

/* Operator styles */
.operator {
  font-size: 32px; /* フォントサイズを大きく */
  font-weight: bold;
  color: #666; /* 元の色に戻す */
  width: 45px; /* 幅を大きく */
  height: 45px; /* 高さを大きく */
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f0f0f0; /* 元の背景色に戻す */
  border-radius: 50%;
  z-index: 10; /* 前面に表示 */
  box-shadow: 0 2px 4px rgba(0,0,0,0.3); /* 影を追加 */
  border: 2px solid #ddd; /* 境界線色を元に近い色に調整 */
}

/* Toggle button styles */
.toggle-btn {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background-color: #ddd;
  border: 1px solid #999;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  position: relative;
  font-size: 0;
  z-index: 2;
}

.toggle-btn::before {
  content: '−';
  font-size: 16px;
  line-height: 1;
}

.toggle-btn.collapsed::before {
  content: '+';
}

/* Collapsed state */
.children.collapsed {
  display: none !important;
}

/* Theme colors */
.theme-default .node {
  border-color: #00796b;
  background-color: #e0f2f1;
}

.theme-blue .node {
  border-color: #1976d2;
  background-color: #e3f2fd;
}

.theme-red .node {
  border-color: #d32f2f;
  background-color: #ffebee;
}
    
    /* 追加のカスタムスタイル - 水平レイアウト専用 */
    .kpi-tree li {
      display: flex;
      flex-direction: row;
      align-items: flex-start !important;
      margin: 3px 0;
    }
    /* 縦方向表示は非表示にし、水平方向表示は表示する */
    .direction-vertical {
      display: none;
    }
    .direction-horizontal {
      display: block;
    }
  </style>
</head>
<body data-theme="default">
  <div class="container">
    <h1>利益KPIツリー</h1>
    <div class="kpi-tree-container theme-default">
      <ul class="kpi-tree">
        
    <li>
      <div class="node" id="node-5wer2c">
        <a href="https://lookerstudio.google.com/u/0/reporting/2bcb0a10-433a-47f3-9fc3-153d2cac06cd/page/p_xsek8mmgrd" target="_blank">利益</a><div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-5wer2c-children"></button>
      <ul id="node-5wer2c-children" class="children">
    <li>
      <div class="node" id="node-m1bum">
        売上<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-m1bum-children"></button>
      <ul id="node-m1bum-children" class="children">
    <li>
      <div class="node" id="node-zddqkc">
        <a href="https://lookerstudio.google.com/u/0/reporting/4565e709-4733-42d8-955a-e56dbbe8c332/page/p_xsek8mmgrd" target="_blank">販売所収益</a><div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-zddqkc-children"></button>
      <ul id="node-zddqkc-children" class="children">
    <li>
      <div class="node" id="node-ssb9vk">
        スプレッド<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-plplc8">
        取引金額<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-plplc8-children"></button>
      <ul id="node-plplc8-children" class="children">
    <li>
      <div class="node" id="node-rgc620">
        取引単価<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-3gfczq">
        取引ユーザー数<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-3gfczq-children"></button>
      <ul id="node-3gfczq-children" class="children">
    <li>
      <div class="node" id="node-67disn">
        既存顧客のうち取引ユーザー<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-67disn-children"></button>
      <ul id="node-67disn-children" class="children">
    <li>
      <div class="node" id="node-kdopp3">
        月末本人確認済既存口座数<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-e1f2qa">
        既存ユーザー取引率<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-v3fqcf">
        新規顧客のうち取引ユーザー<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-v3fqcf-children"></button>
      <ul id="node-v3fqcf-children" class="children">
    <li>
      <div class="node" id="node-micj6l">
        新規口座開設数<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-micj6l-children"></button>
      <ul id="node-micj6l-children" class="children">
    <li>
      <div class="node" id="node-pag6y3">
        広告宣伝費<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-lo2z1c">
        Blended CPA<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-7syyqi">
        新規ユーザー取引率<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li>
      </ul>
    </li>
      </ul>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-9k0dgy">
        <a href="https://lookerstudio.google.com/u/0/reporting/f2d1fa3c-f6cc-47bd-832b-5935c4f206e9/page/p_xsek8mmgrd" target="_blank">販売所以外収益</a><div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-9k0dgy-children"></button>
      <ul id="node-9k0dgy-children" class="children">
    <li>
      <div class="node" id="node-w0nv76">
        <a href="https://lookerstudio.google.com/u/0/reporting/758085d1-c9d8-4e7e-898f-8a2d74904045/page/p_xsek8mmgrd" target="_blank">取引所</a><div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-w0nv76-children"></button>
      <ul id="node-w0nv76-children" class="children">
    <li>
      <div class="node" id="node-fdmndp">
        出来高<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-fdmndp-children"></button>
      <ul id="node-fdmndp-children" class="children">
    <li>
      <div class="node" id="node-26y94x">
        MTU<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-ze9hlc">
        平均約定回数<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-gv6dgb">
        平均約定金額<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-itkgyk">
        手数料率<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-1giigg">
        <a href="https://lookerstudio.google.com/u/0/reporting/e4ad8b3b-913a-4312-8ed1-3709a5b75956/page/p_9nnkwdngrd" target="_blank">つみたて</a><div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-1giigg-children"></button>
      <ul id="node-1giigg-children" class="children">
    <li>
      <div class="node" id="node-r73lf7">
        つみたて件数<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-r73lf7-children"></button>
      <ul id="node-r73lf7-children" class="children">
    <li>
      <div class="node" id="node-6uxs6r">
        新規UU<div class="value">1000</div>
      </div>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-m9jd71">
        再開UU<div class="value">1000</div>
      </div>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-wzw3w7">
        継続UU<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-xjtlpm">
        ARPPU<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-xjtlpm-children"></button>
      <ul id="node-xjtlpm-children" class="children">
    <li>
      <div class="node" id="node-5012wn">
        一人当たりつみたて金額<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-jmmuye">
        スプレッド<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-6wbhyf">
        日本円入出金・暗号資産送金<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-6wbhyf-children"></button>
      <ul id="node-6wbhyf-children" class="children">
    <li>
      <div class="node" id="node-bfx0i">
        入金<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-bfx0i-children"></button>
      <ul id="node-bfx0i-children" class="children">
    <li>
      <div class="node" id="node-avkhr1">
        入金金額<div class="value">1000</div>
      </div>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-plcutl">
        手数料率<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-dayx7a">
        出金<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-dayx7a-children"></button>
      <ul id="node-dayx7a-children" class="children">
    <li>
      <div class="node" id="node-c6fa1j">
        出金金額<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-plcvka">
        手数料率<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-s1spds">
        暗号資産送金<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-s1spds-children"></button>
      <ul id="node-s1spds-children" class="children">
    <li>
      <div class="node" id="node-6v8s3n">
        送金金額<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-6v8s3n-children"></button>
      <ul id="node-6v8s3n-children" class="children">
    <li>
      <div class="node" id="node-bf2spi">
        送金UU<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-l0nmmz">
        平均送金金額<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-plcwaz">
        手数料率<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-cl7p4b">
        ステーキング<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-cl7p4b-children"></button>
      <ul id="node-cl7p4b-children" class="children">
    <li>
      <div class="node" id="node-pb3a44">
        ETH保有金額<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-pb3a44-children"></button>
      <ul id="node-pb3a44-children" class="children">
    <li>
      <div class="node" id="node-bievha">
        保有UU<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-tpimv1">
        一人当たり保有金額<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-itkeqh">
        手数料率<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-dejub7">
        NFT<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-dejub7-children"></button>
      <ul id="node-dejub7-children" class="children">
    <li>
      <div class="node" id="node-9o7uth">
        CC出品<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-bvbdju">
        CtoC<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-zhjq5l">
        発行体<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-nahm9y">
        出庫手数料<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-w1g4px">
        IEO<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-w1g4px-children"></button>
      <ul id="node-w1g4px-children" class="children">
    <li>
      <div class="node" id="node-cm2qlp">
        PLT<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-jxs4oh">
        FNCT<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-d2db7a">
        BRIL<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-2i6x3w">
        OnRamp<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-2i6x3w-children"></button>
      <ul id="node-2i6x3w-children" class="children">
    <li>
      <div class="node" id="node-53oq3o">
        MTU<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-53oq3o-children"></button>
      <ul id="node-53oq3o-children" class="children">
    <li>
      <div class="node" id="node-royrhj">
        MTUrate<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-3eyakb">
        MAU<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-xjti05">
        ARPPU<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-xjti05-children"></button>
      <ul id="node-xjti05-children" class="children">
    <li>
      <div class="node" id="node-6mojup">
        一人当たり売買金額<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-jjvvzl">
        スプレッド<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-na1dm">
        リワード<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-na1dm-children"></button>
      <ul id="node-na1dm-children" class="children">
    <li>
      <div class="node" id="node-nh3gq8">
        案件クリアUU<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-mommlt">
        CCが受け取る広告費<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-bo6nzj">
        実現損益<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-bo6nzj-children"></button>
      <ul id="node-bo6nzj-children" class="children">
    <li>
      <div class="node" id="node-8ppp6i">
        有料会員登録UU<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-xjtgir">
        ARPPU<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-fhyq3h">
        でんき・ガス<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-fhyq3h-children"></button>
      <ul id="node-fhyq3h-children" class="children">
    <li>
      <div class="node" id="node-90cswc">
        契約UU<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-xjtfs2">
        ARPPU<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-fh2wlo">
        Coincheck Prime<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-fh2wlo-children"></button>
      <ul id="node-fh2wlo-children" class="children">
    <li>
      <div class="node" id="node-oipk5m">
        アセットロック<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-emd3r0">
        大口OTC<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li>
      </ul>
    </li>
      </ul>
    </li><li class="operator">-</li>
    <li>
      <div class="node" id="node-vl9zjo">
        <a href="https://lookerstudio.google.com/u/0/reporting/f2d1fa3c-f6cc-47bd-832b-5935c4f206e9/page/p_xsek8mmgrd" target="_blank">費用</a><div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-vl9zjo-children"></button>
      <ul id="node-vl9zjo-children" class="children">
    <li>
      <div class="node" id="node-uesom4">
        <a href="https://lookerstudio.google.com/u/0/reporting/0d428906-56d6-4382-a942-672d3abf5666/page/p_xsek8mmgrd" target="_blank">マーケティング費用</a><div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-uesom4-children"></button>
      <ul id="node-uesom4-children" class="children">
    <li>
      <div class="node" id="node-h8q3c1">
        広告費<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-h8q3c1-children"></button>
      <ul id="node-h8q3c1-children" class="children">
    <li>
      <div class="node" id="node-lqmvfm">
        ターゲット広告費用<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-plsf9i">
        SNSマーケティング<div class="value">1000</div>
      </div>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-65atfb">
        インフルエンサー活用費<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">×</li>
    <li>
      <div class="node" id="node-i74cau">
        キャンペーンROI<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-kq7jth">
        運用費用<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-kq7jth-children"></button>
      <ul id="node-kq7jth-children" class="children">
    <li>
      <div class="node" id="node-xt0b8i">
        <a href="https://lookerstudio.google.com/u/0/reporting/3237c443-4e9a-4317-bd38-3764996f72eb/page/p_quxr4t6ufd" target="_blank">プラットフォーム維持費用</a><div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-xt0b8i-children"></button>
      <ul id="node-xt0b8i-children" class="children">
    <li>
      <div class="node" id="node-bo1r8x">
        サーバー費用<div class="value">1000</div>
      </div>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-au3nrh">
        外部サービス利用料<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-efoomb">
        従業員費用<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-efoomb-children"></button>
      <ul id="node-efoomb-children" class="children">
    <li>
      <div class="node" id="node-2y5qol">
        開発チーム費用<div class="value">1000</div>
      </div>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-n0z9uw">
        運用チーム費用<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-1ctnhp">
        セキュリティ費用<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-1ctnhp-children"></button>
      <ul id="node-1ctnhp-children" class="children">
    <li>
      <div class="node" id="node-limmp9">
        セキュリティインフラ費用<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-limmp9-children"></button>
      <ul id="node-limmp9-children" class="children">
    <li>
      <div class="node" id="node-rmmn2u">
        DDoS攻撃対策<div class="value">1000</div>
      </div>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-c85xkc">
        暗号化対応費用<div class="value">1000</div>
      </div>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-rldbzl">
        WAF/IPS導入費用<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-ust6z1">
        コンプライアンス費用<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-ust6z1-children"></button>
      <ul id="node-ust6z1-children" class="children">
    <li>
      <div class="node" id="node-yrjwce">
        警察対応コスト<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-yrjwce-children"></button>
      <ul id="node-yrjwce-children" class="children">
    <li>
      <div class="node" id="node-sxb75h">
        捜査協力・データ提出<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-tgpclv">
        KYC・AML対策費用<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-tgpclv-children"></button>
      <ul id="node-tgpclv-children" class="children">
    <li>
      <div class="node" id="node-boye7t">
        取引モニタリング<div class="value">1000</div>
      </div>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-5mnpuz">
        制裁・反社チェック<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-v5bj84">
        法令改正対応<div class="value">1000</div>
      </div>
      <button class="toggle-btn" data-target="node-v5bj84-children"></button>
      <ul id="node-v5bj84-children" class="children">
    <li>
      <div class="node" id="node-yskdx2">
        当局レポート作成<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li><li class="operator">+</li>
    <li>
      <div class="node" id="node-j3cm2v">
        RegTechツール利用料<div class="value">1000</div>
      </div>
    </li>
      </ul>
    </li>
      </ul>
    </li>
      </ul>
    </li>
      </ul>
    </li>
      </ul>
    </div>
  </div>
  
  <script>window.PUBLIC_URL = "https://storage.cloud.google.com/cc-data-platform-kpi-tree-viewer-prod/index.html";</script>
  <script>
    // KPIツリージェネレーター用JavaScript
// 初期化時に実行される関数
function kpiTreeInit() {
  // グローバル変数の初期化
  window._initialLoadComplete = false;
  window._shareUrl = null;
  
  // リダイレクトパラメータを処理
  handleUrlRedirects();
  
  // 固定で横レイアウトに設定
  setDirection('horizontal');
  
  // 共有ボタンの追加
  addShareButton();
  
  // URLからツリー状態を取得
  var state = getStateFromUrl();
  
  // 状態が空の場合はセッションストレージからそのまま取得を試みる
  if (!state || Object.keys(state).length === 0) {
    try {
      var savedStateParam = sessionStorage.getItem('originalStateParam');
      if (savedStateParam) {
        // 保存されたパラメータから状態をデコード
        var decodedState = decodeURIComponent(savedStateParam.split('.')[0]);
        decodedState = atob(decodedState.replace(/-/g, '+').replace(/_/g, '/'));
        state = JSON.parse(decodedState);
        console.log('セッションストレージから状態を復元:', state);
      }
    } catch (e) {
      console.error('セッションからの状態読み込み失敗:', e);
    }
  }
  
  // ツリー状態を適用
  applyTreeState(state);
  
  // トグルボタンの設定
  setupToggleButtons();
  
  // 共有URLを更新
  setTimeout(updateShareUrl, 500);
  
  // 初期ロード完了フラグをセット
  window._initialLoadComplete = true;
}

// リダイレクト時のパラメータ保持を処理する関数
function handleUrlRedirects() {
  // URLパラメータをセッションストレージに保存する処理
  function saveStateParamToStorage() {
    var urlParams = new URLSearchParams(window.location.search);
    var stateParam = urlParams.get('state');
    
    if (stateParam) {
      try {
        // セッションストレージに保存
        sessionStorage.setItem('originalStateParam', stateParam);
        return true;
      } catch (e) {
        console.error('パラメータの保存に失敗:', e);
      }
    }
    return false;
  }
  
  // Google Storageリダイレクトを検出
  var isGcsRedirect = window.location.href.includes('googleusercontent.com') && 
                     (!document.referrer || document.referrer.includes('storage.cloud.google.com'));
  
  // 1. 最初のアクセス時にパラメータを保存
  if (!isGcsRedirect) {
    saveStateParamToStorage();
  }
  // 2. リダイレクト後なら保存済みパラメータを復元
  else {
    var savedState = sessionStorage.getItem('originalStateParam');
    if (savedState) {
      var currentUrl = new URL(window.location.href);
      currentUrl.searchParams.set('state', savedState);
      window.history.replaceState({}, document.title, currentUrl.toString());
      console.log('リダイレクト後にstateパラメータを復元しました:', savedState);
      return true;
    }
  }
  
  return false;
}

// 方向を設定する関数
function setDirection(direction) {
  var treeContainer = document.querySelector('.kpi-tree-container');
  
  // クラスを更新
  treeContainer.classList.remove('direction-vertical');
  treeContainer.classList.remove('direction-horizontal');
  treeContainer.classList.add('direction-' + direction);
  
  // data属性を更新
  document.body.setAttribute('data-direction', direction);
}

// トグルボタンの設定
function setupToggleButtons() {
  // トグルボタンを取得
  var toggleButtons = document.querySelectorAll('.toggle-btn');
  if (!toggleButtons.length) return;
  
  // 保存された状態を読み込む
  var savedStates = loadTreeState();
  
  // 各ボタンにイベントを設定
  toggleButtons.forEach(function(button) {
    var targetId = button.getAttribute('data-target');
    var target = document.getElementById(targetId);
    if (!target) return;
    
    // クリックイベントを設定
    button.onclick = function() {
      target.classList.toggle('collapsed');
      button.classList.toggle('collapsed');
      saveTreeState();
      updateShareUrl();
    };
  });
}

// ツリーの状態を保存
function saveTreeState() {
  var state = {};
  // すべてのトグル可能ノードを取得
  document.querySelectorAll('.children').forEach(function(child) {
    if (child.id) {
      // 明示的にcollapsedまたはexpandedの状態を記録
      state[child.id] = child.classList.contains('collapsed') ? 'collapsed' : 'expanded';
    }
  });
  
  // デフォルト状態と異なるノードのみを取得
  var defaultExpanded = {};
  var filteredState = {};
  var hasChanges = false;
  
  // デフォルト状態はexpanded
  for (var nodeId in state) {
    // collapsedのノードのみを記録する
    if (state[nodeId] === 'collapsed') {
      filteredState[nodeId] = 'collapsed';
      hasChanges = true;
    }
  }
  
  // ローカルストレージに保存
  localStorage.setItem('kpiTreeState', JSON.stringify(state));
  
  // 変更がある場合のみ状態を返す
  return hasChanges ? filteredState : {};
}

// ツリーの状態を読み込む
function loadTreeState() {
  try {
    var savedState = localStorage.getItem('kpiTreeState');
    return savedState ? JSON.parse(savedState) : {};
  } catch (e) {
    return {};
  }
}

// URLパラメータからツリーの状態を取得
function getStateFromUrl() {
  // URLパラメータを確認
  var urlParams = new URLSearchParams(window.location.search);
  var stateParam = urlParams.get('state');
  
  if (!stateParam) {
    // 1. URLから取得できない場合はセッションストレージから取得を試みる
    try {
      var savedStateParam = sessionStorage.getItem('originalStateParam');
      if (savedStateParam) {
        stateParam = savedStateParam;
        console.log('セッションストレージからパラメータを取得:', stateParam);
      } else {
        return {}; // パラメータがなければ空オブジェクトを返す
      }
    } catch (storageError) {
      return {}; // エラー時は空オブジェクトを返す
    }
  } else {
    // 取得したパラメータをセッションに保存
    try {
      sessionStorage.setItem('originalStateParam', stateParam);
    } catch (e) {
      // 保存失敗しても続行
    }
  }
  
  try {
    // ハッシュ部分とデータ部分を分離
    var parts = stateParam.split('.');
    var encodedData = parts[0]; // データ部分
    
    // データ部分をデコード
    var decodedState = decodeURIComponent(encodedData);
    // URL-safe base64を標準base64に変換してデコード
    decodedState = atob(decodedState.replace(/-/g, '+').replace(/_/g, '/'));
    // JSONにパース
    var parsedState = JSON.parse(decodedState);
    
    return parsedState;
  } catch (e) {
    console.error('State decoding error:', e);
    
    // 旧形式のパラメータの場合は直接デコードを試みる
    try {
      var directDecodedState = decodeURIComponent(stateParam);
      directDecodedState = atob(directDecodedState.replace(/-/g, '+').replace(/_/g, '/'));
      var directParsedState = JSON.parse(directDecodedState);
      return directParsedState;
    } catch (directError) {
      return {}; // エラー時は空オブジェクトを返す
    }
  }
}

// ツリー状態をURLパラメータ用にエンコード
function generateStateParam(state) {
  if (!state || Object.keys(state).length === 0) {
    return '';
  }
  
  try {
    // 1. ノードデータの正規化
    var normalizedState = {};
    var nodeIds = Object.keys(state).sort(); // キーをソートして一貫性を確保
    
    // 2. ソートされたキー順に再構築
    for (var i = 0; i < nodeIds.length; i++) {
      var nodeId = nodeIds[i];
      normalizedState[nodeId] = state[nodeId];
    }
    
    // 3. フィンガープリントを生成
    // ノードIDと全体のあり方から一意のハッシュを生成
    var fingerprint = '';
    for (var j = 0; j < nodeIds.length; j++) {
      var id = nodeIds[j];
      var val = state[id];
      fingerprint += id.substring(0, 3) + val.substring(0, 1);
    }
    
    // 4. 状態のチェックサムを計算
    var checksum = 0;
    for (var k = 0; k < fingerprint.length; k++) {
      checksum += fingerprint.charCodeAt(k);
    }
    checksum = checksum % 1000; // 3桁に制限
    
    // 5. 正規化されたJSON文字列に変換
    var jsonString = JSON.stringify(normalizedState);
    
    // 6. Base64にエンコードし、URL安全な形式に変換
    var encoded = btoa(jsonString).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    
    // 7. ユニーク性を確保するハッシュを生成
    var uniqueHash = 's' + checksum + '-n' + nodeIds.length;
    
    // 8. URLエンコード
    return encodeURIComponent(encoded) + '.' + uniqueHash;
  } catch (e) {
    console.error('State encoding error:', e);
    return '';
  }
}

// 共有ボタンを追加する関数
function addShareButton() {
  // ボタンコンテナを作成
  var shareDiv = document.createElement('div');
  shareDiv.className = 'share-control';
  shareDiv.style.position = 'fixed';
  shareDiv.style.top = '10px';
  shareDiv.style.right = '10px';
  shareDiv.style.zIndex = '1000';
  shareDiv.style.background = '#fff';
  shareDiv.style.padding = '5px 10px';
  shareDiv.style.borderRadius = '4px';
  shareDiv.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
  
  // ボタン要素を作成
  var shareButton = document.createElement('button');
  shareButton.id = 'shareButton';
  shareButton.textContent = '現在のURLをコピー';
  shareButton.style.padding = '5px 10px';
  shareButton.style.cursor = 'pointer';
  shareButton.style.backgroundColor = '#4CAF50';
  shareButton.style.color = 'white';
  shareButton.style.border = 'none';
  shareButton.style.borderRadius = '4px';
  shareButton.style.position = 'relative';
  
  // ツールチップ要素
  var tooltip = document.createElement('div');
  tooltip.id = 'shareTooltip';
  tooltip.textContent = '現在のURLをコピーしました';
  tooltip.style.position = 'absolute';
  tooltip.style.top = '100%';
  tooltip.style.left = '50%';
  tooltip.style.transform = 'translateX(-50%)';
  tooltip.style.backgroundColor = '#333';
  tooltip.style.color = 'white';
  tooltip.style.padding = '5px 10px';
  tooltip.style.borderRadius = '4px';
  tooltip.style.fontSize = '12px';
  tooltip.style.whiteSpace = 'nowrap';
  tooltip.style.opacity = '0';
  tooltip.style.transition = 'opacity 0.3s';
  tooltip.style.pointerEvents = 'none';
  tooltip.style.zIndex = '1001';
  shareButton.appendChild(tooltip);
  
  // クリックイベントを設定
  shareButton.onclick = function() {
    copyShareUrlToClipboard();
  };
  
  // DOMに追加
  shareDiv.appendChild(shareButton);
  document.body.appendChild(shareDiv);
}

// ツリー状態が変更されたときにURLを更新
function updateShareUrl() {
  // 現在のツリー状態を取得
  var state = saveTreeState();
  
  // 開閉状態が変更されている場合のみパラメータを生成
  if (state && Object.keys(state).length > 0) {
    var stateParam = generateStateParam(state);
    // クエリパラメータを生成
    var queryString = stateParam ? '?state=' + stateParam : '';
    
    // 共有URLを設定
    if (window._publicBaseUrl) {
      window._shareUrl = window._publicBaseUrl + queryString;
    } else {
      var fileName = window.location.pathname.split('/').pop() || 'index.html';
      window._shareUrl = fileName + queryString;
    }
    
    // ブラウザのURLを更新
    updateBrowserUrl(queryString);
  } else {
    // 変更がない場合はベースURLのみ
    if (window._publicBaseUrl) {
      window._shareUrl = window._publicBaseUrl;
    } else {
      var fileName = window.location.pathname.split('/').pop() || 'index.html';
      window._shareUrl = fileName;
    }
    
    // ブラウザのURLからクエリパラメータを削除
    updateBrowserUrl('');
  }
  
  // コンソールに現在の共有URLを表示
  console.log('Share URL updated:', window._shareUrl);
}

// URLをクリップボードにコピー
function copyShareUrlToClipboard() {
  var shareUrl = window._shareUrl;
  if (!shareUrl) return;
  
  // 完全URLを生成
  var fullUrl;
  if (shareUrl.startsWith('http')) {
    fullUrl = shareUrl;
  } else if (shareUrl.startsWith('?')) {
    fullUrl = window.location.origin + window.location.pathname + shareUrl;
  } else {
    var path = window.location.pathname.split('/');
    path.pop();
    fullUrl = window.location.origin + path.join('/') + '/' + shareUrl;
  }
  
  // クリップボードにコピー
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(fullUrl)
      .then(showCopySuccess)
      .catch(function() {
        fallbackCopyToClipboard(fullUrl);
      });
  } else {
    fallbackCopyToClipboard(fullUrl);
  }
}

// 代替コピー方法
function fallbackCopyToClipboard(text) {
  var tempInput = document.createElement('input');
  tempInput.style.position = 'absolute';
  tempInput.style.left = '-9999px';
  tempInput.value = text;
  document.body.appendChild(tempInput);
  
  tempInput.select();
  var success = document.execCommand('copy');
  document.body.removeChild(tempInput);
  
  if (success) {
    showCopySuccess();
  }
}

// コピー成功表示
function showCopySuccess() {
  var tooltip = document.getElementById('shareTooltip');
  if (!tooltip) return;
  
  tooltip.style.opacity = '1';
  
  setTimeout(function() {
    tooltip.style.opacity = '0';
  }, 1000);
}

// すべてのノードを展開状態にリセット
function resetAllNodes() {
  // すべての子要素とボタンからcollapsedクラスを削除
  document.querySelectorAll('.children').forEach(function(child) {
    child.classList.remove('collapsed');
  });
  
  document.querySelectorAll('.toggle-btn').forEach(function(button) {
    button.classList.remove('collapsed');
  });
}

// ブラウザのURLを更新
function updateBrowserUrl(queryString) {
  if (window.history && window.history.replaceState) {
    try {
      // クエリ文字列だけを更新
      window.history.replaceState({}, document.title, queryString);
      
      // 状態をセッションに保存
      var state = saveTreeState();
      if (Object.keys(state).length > 0) {
        sessionStorage.setItem('kpiTreeState', JSON.stringify(state));
      }
    } catch (e) {
      // URL更新失敗の場合は無視
    }
  }
}

// リダイレクト時のURLパラメータを処理
function handleRedirectParams() {
  var urlParams = new URLSearchParams(window.location.search);
  var hasStateParam = urlParams.has('state');
  
  // 状態パラメータがない場合は何もしない
  if (!hasStateParam) return false;
  
  // 状態パラメータを取得
  var stateParam = urlParams.get('state');
  
  // オリジナルパラメータをグローバル変数に保存
  try {
    window._originalStateParam = stateParam;
  } catch (e) {
    // エラー時は無視
  }

  // 公開URLが設定されている場合
  if (window._publicBaseUrl) {
    // URLが.htmlで終わっていない場合は修正
    if (!window._publicBaseUrl.toLowerCase().endsWith('.html')) {
      if (!window._publicBaseUrl.endsWith('/')) {
        window._publicBaseUrl += '/';
      }
      window._publicBaseUrl += 'index.html';
    }
  }
  
  return false;
}

// ツリー状態を適用
function applyTreeState(state) {
  if (!state || Object.keys(state).length === 0) return;
  
  // まずすべてのノードを展開状態にリセット
  resetAllNodes();
  
  // 各ノードに状態を適用
  for (var nodeId in state) {
    var nodeState = state[nodeId];
    var node = document.getElementById(nodeId);
    
    // 関連するトグルボタンを探す
    var button = null;
    document.querySelectorAll('.toggle-btn').forEach(function(btn) {
      if (btn.getAttribute('data-target') === nodeId) {
        button = btn;
      }
    });
    
    // ノードとボタンの両方が存在する場合のみ状態を適用
    if (node && button) {
      if (nodeState === 'collapsed') {
        node.classList.add('collapsed');
        button.classList.add('collapsed');
      } else if (nodeState === 'expanded') {
        node.classList.remove('collapsed');
        button.classList.remove('collapsed');
      }
    }
  }
  
  // 状態をローカルストレージに保存
  saveTreeState();
  
  // 初期化完了を記録
  window._initialLoadComplete = true;
}

// Capture state parameter before DOMContentLoaded
(function() {
  try {
    // ページが実際にロードされる前に状態パラメータを保存
    var urlParams = new URLSearchParams(window.location.search);
    var stateParam = urlParams.get('state');
    if (stateParam) {
      window._originalStateParam = stateParam;
      if (window.sessionStorage) {
        sessionStorage.setItem('originalStateParam', stateParam);
        console.log('Early state parameter capture success');
      }
    }
  } catch (e) {
    console.error('Early state parameter capture failed:', e);
  }
})();

// ページURLを監視して変更を検出
function monitorUrlChanges() {
  var lastUrl = window.location.href;
  setInterval(function() {
    if (lastUrl !== window.location.href) {
      console.log('URL changed from', lastUrl, 'to', window.location.href);
      lastUrl = window.location.href;
      
      // Googleストレージへのリダイレクトをチェック
      if (window.location.href.includes('googleusercontent.com')) {
        console.log('Google Storage redirect detected');
        var savedState = sessionStorage.getItem('originalStateParam');
        if (savedState) {
          // リダイレクト後は状態を復元
          var state = getStateFromUrl();
          applyTreeState(state);
        }
      }
    }
  }, 500); // 500ms間隔で確認
}

// Run initialization when page is loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM content loaded, initializing KPI tree');
  
  // URL監視を開始
  monitorUrlChanges();
  
  // KPIツリーの動作を初期化
  kpiTreeInit();
  
  // 通常のURL処理（リダイレクト処理されていない場合のみ）
  if (!redirectHandled) {
    // URLからツリー状態を取得して適用
    var state = getStateFromUrl();
    
    if (Object.keys(state).length > 0) {
      console.log('Applying state from URL');
      // DOM完全読み込み後に適用を確実に実行
      if (document.readyState === 'loading') {
        console.log('DOM still loading, deferring state application');
        document.addEventListener('DOMContentLoaded', function() {
          console.log('DOM now loaded, applying state');
          setTimeout(function() {
            applyTreeState(state);
          }, 100); // 少し遅延させて確実に適用
        });
      } else {
        // 少し遅延させてツリー状態を適用
        setTimeout(function() {
          applyTreeState(state);
        }, 100);
      }
    }
  }
  
  // 分析ボタン追加
  addShareButton();
  
  // 初期ロード完了フラグをセット
  window._initialLoadComplete = true;
  
  console.log('KPI tree initialization complete');
});

// 最初のページロード時にオリジナルのstateパラメータを保存する関数
function saveOriginalStateParam() {
  // URLの生のパラメータを取得（リダイレクト前に実行）
  var fullUrl = window.location.href;
  var stateIndex = fullUrl.indexOf('state=');
  var urlParams = new URLSearchParams(window.location.search);
  var stateFromParams = urlParams.get('state');
  
  // 状態パラメータを取得する複数の方法を試す
  if (stateFromParams) {
    // 1. 標準のURLSearchParamsで取得できた場合
    window._originalStateParam = stateFromParams;
    console.log('Original state parameter saved from URLSearchParams:', window._originalStateParam);
  } else if (stateIndex !== -1) {
    // 2. パラメータが見つからない場合、URL全体から探索
    var stateSubstring = fullUrl.substring(stateIndex + 6); // 'state='.length = 6
    
    // 次のパラメータがある場合は&までを取得、なければ最後まで
    var nextParamIndex = stateSubstring.indexOf('&');
    if (nextParamIndex !== -1) {
      window._originalStateParam = stateSubstring.substring(0, nextParamIndex);
    } else {
      window._originalStateParam = stateSubstring;
    }
    
    console.log('Original state parameter saved from URL string:', window._originalStateParam);
  }
  
  // オリジナルの状態パラメータが見つかった場合、セッションストレージに保存
  if (window._originalStateParam) {
    // セッションストレージにストリングとして保存
    try {
      // オリジナルパラメータを保存
      sessionStorage.setItem('originalStateParam', window._originalStateParam);
      console.log('Original state param saved to session storage');
      
      // デコードしたオブジェクトも保存しておく
      try {
        var decodedState = decodeURIComponent(window._originalStateParam);
        decodedState = atob(decodedState.replace(/-/g, '+').replace(/_/g, '/'));
        var parsedState = JSON.parse(decodedState);
        
        // オブジェクト状態を保存
        sessionStorage.setItem('kpiTreeState', JSON.stringify(parsedState));
        console.log('Decoded state object saved to session storage');
      } catch (decodeError) {
        console.warn('Could not decode original state parameter:', decodeError);
      }
    } catch (e) {
      console.warn('Could not save original state to sessionStorage:', e);
    }
  } else {
    console.log('No state parameter found in original URL');
  }
}

// デバッグ用：URLパラメータの変更を監視
window.addEventListener('popstate', function(event) {
  console.log('URL changed, reloading state from URL');
  // ページをリロードせずに状態を更新
  var urlStates = getStateFromUrl();
  if (Object.keys(urlStates).length > 0) {
    console.log('Applying new states from URL');
    resetAllNodes();
    
    // 各ノードに状態を適用
    for (var nodeId in urlStates) {
      var target = document.getElementById(nodeId);
      var button = document.querySelector('[data-target="' + nodeId + '"]');
      
      if (target && button && urlStates[nodeId] === 'collapsed') {
        target.classList.add('collapsed');
        button.classList.add('collapsed');
      }
    }
  }
});


  </script>

</body>
</html>